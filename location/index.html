<!DOCTYPE html>
<html>
<head>
    <title>Widget de Geolocalización</title>
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Ubicación GPS</title>
        <style type="text/css" media="all">
            #error-banner {
                background-color: #DC2626;
                color: white;
                padding: 10px;
                margin: 20px 0;
                border: 1px solid #A61E24;
                border-radius: 5px;
                display: none;
            }

            #confirmation-banner {
                background-color: #FFF3CD;
                color: #806421;
                padding: 10px;
                margin: 20px 0;
                border: 1px solid #FCEEC0;
                border-radius: 5px;
                display: none;
            }

            .hidden {
                display: none;
            }

            table {
                width: 100%;
                text-align: center;
                border-collapse: collapse;
                margin-top: 20px;
            }

            th, td {
                border: 1px solid black;
                padding: 8px;
            }

            th {
                background-color: #f2f2f2;
            }

            #map {
                height: 300px;
                width: 100%;
                border: 1px solid black;
                margin-top: 20px;
            }

            .form-required {
                color: #dc2626;
                margin-left: 4px;
            }
        </style>
    </head>
    <body>
        <div id="main">
            <h3>Tu Ubicación GPS<span id="asterisk_required" class="form-required">*</span></h3>
            <div id="error-banner" class="hidden">No se puede acceder a los datos de localización porque el usuario denegó el permiso en el navegador. En <a href="https://support.google.com/chrome/answer/142065?hl=es&co=GENIE.Platform%3DAndroid" target="_blank">este enlace</a> puedes leer unas instrucciones para activar la localización de nuevo.</div>

            <table id="location-table">
                <tbody>
                    <tr>
                        <td><strong>Latitud</strong></td>
                        <td id="latitud">Cargando...</td>
                        <td><strong>Longitud</strong></td>
                        <td id="longitud">Cargando...</td>
                    </tr>
                    <tr>
                        <td><strong>Ría</strong></td>
                        <td id="ria">Cargando...</td>
                        <td><strong>Polígono</strong></td>
                        <td id="poligono">Cargando...</td>
                    </tr>
                </tbody>
            </table>
            <div id="confirmation-banner" class="hidden">Este polígono é o que se vai a usar para rexistrar a incidencia. En caso de que non sexa o correcto, por favor, selecciónao a man.</div>
            <div id="map">
                O mapa aparecerá aquí
            </div>
        </div>

    <script type="text/javascript">
        // ria polygons
        const RIA_PONTEVEDRA = [[-8.8373888, 42.3383835], [-8.8332689, 42.3411432], [-8.8253725, 42.3389545], [-8.8200939, 42.3355919], [-8.8094509, 42.3373366], [-8.8011846, 42.3372287], [-8.8019059, 42.3310673], [-8.791692, 42.3257371], [-8.7692044, 42.3294175], [-8.7448285, 42.3443907], [-8.7441418, 42.3541595], [-8.7346858, 42.3706869], [-8.7097949, 42.3908485], [-8.6847323, 42.3971874], [-8.6757324, 42.407695], [-8.6604545, 42.420622], [-8.6487815, 42.4236633], [-8.6595962, 42.4288585], [-8.6825988, 42.4261976], [-8.686752, 42.4312755], [-8.686237, 42.4377686], [-8.6901852, 42.4392255], [-8.6979958, 42.4372302], [-8.6995407, 42.4358366], [-8.7067958, 42.4342056], [-8.7049934, 42.4317984], [-8.7079975, 42.4288842], [-8.7145206, 42.4221684], [-8.7206146, 42.423689], [-8.7270519, 42.4183667], [-8.7320301, 42.4174796], [-8.7352916, 42.4143747], [-8.7432739, 42.4143113], [-8.7506553, 42.4043618], [-8.7606117, 42.4020168], [-8.7605302, 42.397219], [-8.7720315, 42.3950639], [-8.7752931, 42.3899927], [-8.7792413, 42.3981064], [-8.8036172, 42.4026699], [-8.8281336, 42.4006479], [-8.8301935, 42.3907596], [-8.8391199, 42.390506], [-8.8501921, 42.3992535], [-8.8576593, 42.3993802], [-8.8569727, 42.4035634], [-8.8652124, 42.412816], [-8.8783445, 42.4168715], [-8.924995, 42.3938049], [-8.9435332, 42.357201], [-8.9349501, 42.3448952], [-8.855991, 42.3078158], [-8.8498112, 42.297405], [-8.8480258, 42.2917835], [-8.8394427, 42.2902597], [-8.8380694, 42.2860056], [-8.833177, 42.2823861], [-8.8328337, 42.2771788], [-8.8269313, 42.2765428], [-8.8246138, 42.274193], [-8.8192065, 42.2752092], [-8.8155158, 42.2794005], [-8.8206656, 42.2821946], [-8.8216956, 42.2867031], [-8.818949, 42.2894333], [-8.819464, 42.2948936], [-8.8222096, 42.2985718], [-8.822038, 42.3019998], [-8.8182614, 42.3016189], [-8.8177464, 42.3052373], [-8.8157723, 42.3078398], [-8.8183472, 42.3119656], [-8.8176394, 42.3133206], [-8.8204718, 42.3159228], [-8.8219159, 42.3148249], [-8.8219373, 42.3168241], [-8.8232033, 42.3188867], [-8.8233964, 42.3206161], [-8.8256871, 42.3217282], [-8.824228, 42.3224897], [-8.8259017, 42.3245204], [-8.8255155, 42.3260751], [-8.8283479, 42.3285181], [-8.8255584, 42.3301362], [-8.8262342, 42.3347214], [-8.8319419, 42.3338014], [-8.8334011, 42.3351972], [-8.833444, 42.3383061], [-8.8373888, 42.3383835]];
        const RIA_AROUSA = [[-9.0074773, 42.4691945], [-8.9377828, 42.4626097], [-8.931603, 42.4752722], [-8.909287, 42.4727399], [-8.877358, 42.4881853], [-8.8866277, 42.4945142], [-8.8739248, 42.4955268], [-8.8678743, 42.497412], [-8.8596775, 42.4920011], [-8.8573378, 42.4727908], [-8.8675516, 42.4679792], [-8.8761749, 42.4595347], [-8.8709003, 42.4450241], [-8.8486232, 42.4507956], [-8.8372936, 42.4501623], [-8.8157501, 42.4519356], [-8.8205566, 42.4748567], [-8.8262214, 42.484352], [-8.8226846, 42.4913703], [-8.8058618, 42.4945347], [-8.8144449, 42.5087093], [-8.8079217, 42.5330011], [-8.8233713, 42.5242723], [-8.8230279, 42.5410962], [-8.8295511, 42.5479257], [-8.8331603, 42.5572303], [-8.8256072, 42.549896], [-8.8163375, 42.5571038], [-8.8175391, 42.566713], [-8.8262939, 42.5622879], [-8.8281821, 42.5662073], [-8.8257789, 42.5748038], [-8.8038062, 42.5753094], [-8.7862968, 42.5844103], [-8.7809753, 42.5937625], [-8.767929, 42.5918669], [-8.7652161, 42.603558], [-8.7735417, 42.616571], [-8.7622978, 42.6296443], [-8.7499382, 42.6401263], [-8.7377503, 42.6483338], [-8.7351753, 42.660075], [-8.726401, 42.6669215], [-8.7222811, 42.6762613], [-8.7327525, 42.6756303], [-8.7480303, 42.6657855], [-8.7494036, 42.6534141], [-8.75833, 42.6497527], [-8.7627932, 42.6548028], [-8.7724063, 42.6530353], [-8.7837359, 42.6421767], [-8.8012454, 42.6414191], [-8.8187548, 42.6478588], [-8.8091418, 42.6652806], [-8.8263075, 42.6710009], [-8.8438169, 42.6899303], [-8.8465635, 42.6816021], [-8.842787, 42.6656996], [-8.8469068, 42.6678454], [-8.8541166, 42.6658258], [-8.8584081, 42.653202], [-8.8626997, 42.6477729], [-8.8602964, 42.6408281], [-8.85343, 42.6383025], [-8.8467352, 42.6384288], [-8.8395254, 42.633251], [-8.842272, 42.6303462], [-8.8470785, 42.6318618], [-8.8575498, 42.6316092], [-8.8611547, 42.62441], [-8.8621847, 42.6180941], [-8.8639013, 42.6140517], [-8.8590948, 42.6078612], [-8.8656179, 42.6092509], [-8.8762609, 42.6158203], [-8.8841573, 42.6161993], [-8.8831274, 42.6215048], [-8.8810674, 42.6254204], [-8.8714544, 42.6284518], [-8.8750593, 42.6390602], [-8.8814108, 42.6408281], [-8.8925688, 42.6429748], [-8.8958303, 42.6468891], [-8.9033834, 42.6443637], [-8.9030401, 42.6395653], [-8.9042417, 42.6356505], [-8.9119665, 42.6303462], [-8.9250128, 42.6207469], [-8.9248411, 42.6178415], [-8.9363424, 42.6127884], [-8.938574, 42.6057133], [-8.9368574, 42.5997747], [-8.928961, 42.5930772], [-8.9234678, 42.5930772], [-8.9234678, 42.5884012], [-8.9346258, 42.5877693], [-8.9408056, 42.585368], [-8.9533369, 42.587011], [-8.95986, 42.5824609], [-8.9602033, 42.5782898], [-8.9660398, 42.5699466], [-8.9765112, 42.5704523], [-8.9914457, 42.5664067], [-8.9935056, 42.5586942], [-8.9874975, 42.5500954], [-8.9857809, 42.5437721], [-8.9919607, 42.5356773], [-8.9992465, 42.5318596], [-9.0119494, 42.5279381], [-9.0231074, 42.5222451], [-9.0401495, 42.5229725], [-9.0074773, 42.4691945]];
        const RIA_MUROS_NOIA = [[-9.0850486, 42.5738174], [-9.0665092, 42.5925236], [-9.0349235, 42.6359813], [-9.0356101, 42.6672925], [-9.0156974, 42.703634], [-9.0055245, 42.7109873], [-9.0055245, 42.7241039], [-8.9924782, 42.7268782], [-8.9873284, 42.7397392], [-8.9646691, 42.7389828], [-8.946473, 42.7503287], [-8.9457863, 42.7576394], [-8.9330834, 42.76999], [-8.9238137, 42.7818342], [-8.9148873, 42.7876295], [-8.901841, 42.7828421], [-8.892228, 42.7750304], [-8.8846749, 42.784102], [-8.8915413, 42.7936761], [-8.8946312, 42.8048861], [-8.8932579, 42.8119385], [-8.8812416, 42.8097977], [-8.8750618, 42.8163459], [-8.8719719, 42.8240265], [-8.8814133, 42.8298178], [-8.8833016, 42.8187383], [-8.8877648, 42.8193679], [-8.8932579, 42.8291884], [-8.9004677, 42.8332168], [-8.9097374, 42.8306991], [-8.911454, 42.8241524], [-8.9121407, 42.8142052], [-8.9121407, 42.8031229], [-8.9239853, 42.800352], [-8.9305084, 42.8099236], [-8.9432114, 42.8038786], [-8.9514511, 42.79418], [-8.9596715, 42.7836587], [-8.9723744, 42.8005386], [-8.9888539, 42.7952484], [-8.9840474, 42.7829028], [-8.9917047, 42.7817394], [-9.014364, 42.7865269], [-9.0084196, 42.7944768], [-9.0145994, 42.8058125], [-9.0248991, 42.8032937], [-9.0441252, 42.7890601], [-9.0672995, 42.7904458], [-9.0685011, 42.7803672], [-9.0564848, 42.771673], [-9.0506744, 42.7710737], [-9.0584849, 42.7654029], [-9.0603732, 42.7609919], [-9.0764829, 42.758987], [-9.0824052, 42.7516135], [-9.0792294, 42.7431044], [-9.0850659, 42.7391961], [-9.0878125, 42.7400787], [-9.0850486, 42.5738174]];
        const RIA_BETANZOS = [[-8.346838, 43.3946175], [-8.3073559, 43.4006045], [-8.2987729, 43.380895], [-8.2730236, 43.3831407], [-8.2541409, 43.3616782], [-8.2556528, 43.3502874], [-8.2415766, 43.3393016], [-8.2316202, 43.3407998], [-8.2237238, 43.3283139], [-8.2137674, 43.3248173], [-8.1983179, 43.3313107], [-8.2017511, 43.351286], [-8.2031244, 43.3715043], [-8.2120508, 43.3819852], [-8.2072443, 43.3927138], [-8.2029751, 43.4077341], [-8.1801441, 43.4101035], [-8.1571415, 43.3983802], [-8.1464985, 43.4118493], [-8.1566265, 43.4208271], [-8.1775692, 43.4225726], [-8.1955937, 43.4293049], [-8.2141331, 43.4225726], [-8.2230595, 43.4306762], [-8.248122, 43.4305515], [-8.2479504, 43.4233207], [-8.2557097, 43.4235704], [-8.2725325, 43.4360368], [-8.2845488, 43.4412719], [-8.2945052, 43.4382805], [-8.3024016, 43.4430168], [-8.3144179, 43.4442632], [-8.346838, 43.3946175]];
        const RIA_VIGO = [[-8.8992831, 42.1117719], [-8.8884684, 42.1117719], [-8.8843485, 42.1115172], [-8.8798853, 42.109225], [-8.8711306, 42.1138094], [-8.8670107, 42.1148281], [-8.8606593, 42.1209401], [-8.8525912, 42.1214494], [-8.8410899, 42.1135547], [-8.8330218, 42.1120266], [-8.8125941, 42.1143187], [-8.8134524, 42.121704], [-8.8198039, 42.1253963], [-8.8153407, 42.1377449], [-8.8200614, 42.1436001], [-8.8286444, 42.1499639], [-8.8315627, 42.1507275], [-8.8161131, 42.1596355], [-8.8089034, 42.1883872], [-8.7931105, 42.1941105], [-8.7728545, 42.2045384], [-8.7711379, 42.2210668], [-8.7368056, 42.2251347], [-8.7251326, 42.2378451], [-8.7076232, 42.2403869], [-8.7052199, 42.2475033], [-8.7029809, 42.254617], [-8.6990327, 42.2584286], [-8.6907929, 42.254617], [-8.6753434, 42.2643997], [-8.666417, 42.2767212], [-8.6543573, 42.2840134], [-8.6450875, 42.2884582], [-8.6277497, 42.2824894], [-8.6109269, 42.2845214], [-8.609382, 42.2887121], [-8.6162484, 42.2909979], [-8.6129869, 42.2955692], [-8.6128152, 42.3031872], [-8.6196817, 42.309281], [-8.6152185, 42.3146125], [-8.6086953, 42.3281933], [-8.6131585, 42.3313659], [-8.6097253, 42.3379645], [-8.6123002, 42.3505253], [-8.631183, 42.3525551], [-8.6419976, 42.3455775], [-8.6480058, 42.3379645], [-8.6445726, 42.3331426], [-8.6394227, 42.3323812], [-8.6401094, 42.3273049], [-8.6639703, 42.3179128], [-8.6620527, 42.3035172], [-8.6567312, 42.2980577], [-8.6622244, 42.2932327], [-8.6788755, 42.2923438], [-8.6867719, 42.2843435], [-8.6924368, 42.2806605], [-8.7022215, 42.2847245], [-8.7108045, 42.2783743], [-8.7162977, 42.2917089], [-8.7217909, 42.2865024], [-8.7353521, 42.2875184], [-8.7374979, 42.2793904], [-8.7374979, 42.2744369], [-8.7426477, 42.2727856], [-8.7504583, 42.269229], [-8.7552648, 42.2667519], [-8.7643629, 42.2603364], [-8.7788548, 42.2643802], [-8.785638, 42.2630629], [-8.7889425, 42.2559164], [-8.7898866, 42.2504211], [-8.7996713, 42.2511199], [-8.8085977, 42.2569011], [-8.8090269, 42.259061], [-8.8164941, 42.2607126], [-8.8188116, 42.2567741], [-8.8264505, 42.2529623], [-8.8322011, 42.2535341], [-8.832802, 42.2564564], [-8.8346902, 42.2583622], [-8.8497964, 42.2617289], [-8.8575476, 42.26209], [-8.8620966, 42.2548482], [-8.8616675, 42.2524976], [-8.8640707, 42.249448], [-8.8692206, 42.2542764], [-8.9144533, 42.2491939], [-8.903467, 42.2362316], [-8.9053553, 42.2174188], [-8.9060419, 42.1963113], [-8.8992831, 42.1117719]];

        // 2. Función para verificar si un punto está dentro de un polígono (ray-casting algorithm)
        function point_inside_polygon(lat, lon, poligono) {
            let dentro = false;
            for (let i = 0, j = poligono.length - 1; i < poligono.length; j = i++) {
                let xi = poligono[i][1], yi = poligono[i][0]; // Latitud, Longitud
                let xj = poligono[j][1], yj = poligono[j][0];

                let intersect = ((yi > lon) !== (yj > lon)) &&
                                (lat < (xj - xi) * (lon - yi) / (yj - yi) + xi);
                if (intersect) dentro = !dentro;
            }
            return dentro;
        }

        // 3. Función para determinar en qué ría se encuentra el usuario
        function determinarRia(latitud, longitud) {
            if (point_inside_polygon(latitud, longitud, RIA_PONTEVEDRA)) {
                return "Ría de Pontevedra";
            } else if (point_inside_polygon(latitud, longitud, RIA_AROUSA)) {
                return "Ría de Arousa";
            } else if (point_inside_polygon(latitud, longitud, RIA_MUROS_NOIA)) {
                return "Ría de Muros y Noia";
            } else if (point_inside_polygon(latitud, longitud, RIA_VIGO)) {
                return "Ría de Vigo";
            } else if (point_inside_polygon(latitud, longitud, RIA_BETANZOS)) {
                return "Ría de Betanzos";
            } else {
                return "out_of_ria";
            }
        }

        // Modificación en show_location para buscar si está dentro de una ría
        function show_location(posicion) {
            var latitud = posicion.coords.latitude.toFixed(3);;
            var longitud = posicion.coords.longitude.toFixed(3);;
            document.getElementById('latitud').innerHTML = latitud;
            document.getElementById('longitud').innerHTML = longitud;

            // Determinar en qué ría se encuentra el usuario
            var ria = determinarRia(latitud, longitud);
            console.log('RIA: ' + ria);
            if (ria === 'out_of_ria') {
                show_error_out_of_ria({ error: 'out_of_ria' });
                JFCustomWidget.sendData({value: ''});  // to force required value
            } else {
                document.getElementById('ria').textContent = ria; // Usar textContent para evitar problemas de seguridad
                buscarCercano(latitud, longitud, ria);

                var polygon = document.getElementById('poligono').textContent; // TODO: check a possible asynchronouse problem?
                document.getElementById('confirmation-banner').style.display = 'block';
                document.getElementById('asterisk_required').style.display = 'none';
                JFCustomWidget.sendData({
                    value: JSON.stringify({ lon: longitud, lat: latitud, ria: ria, polygon: polygon })
                });
            }

            var map = document.getElementById('map');
            var urlMapa = `https://maps.google.com/maps?q=${latitud},${longitud}&z=10&output=embed&maptype=satellite`;
            map.innerHTML = `<iframe width="100%" height="100%" src="${urlMapa}" frameborder="0" allowfullscreen></iframe>`;
        }

        function get_location() {
            if (navigator.geolocation) {
                var options = {
                    enableHighAccuracy: true,
                    timeout: 10000,           // 10 seconds
                    maximumAge: 0             // don't use cache
                };
                navigator.geolocation.getCurrentPosition(
                    show_location, show_error, options
                );
            } else {
                document.getElementById('error-banner').innerHTML = 'A xeolocalización non é soportada polo teu navegador';
                document.getElementById('error-banner').style.display = 'block';
                document.getElementById('asterisk_required').style.display = 'inline';
                JFCustomWidget.sendData('');
            }
        }

        function show_error(error) {
            if (error.code === error.PERMISSION_DENIED) {
                document.getElementById('error-banner').style.display = 'block';
                document.getElementById('location-table').style.display = 'none';
                document.getElementById('map').style.display = 'none';
                JFCustomWidget.requestFrameResize({
                    // width: newWidth,
                    height: 160
                });
            }
            document.getElementById('asterisk_required').style.display = 'inline';
            JFCustomWidget.sendData('');
        }

        function show_error_out_of_ria() {
            document.getElementById('error-banner').innerHTML = `
                Tu localización no está dentro de ninguna ría
                o tu localización no es correcta.
                Debes elegir la localización manualmente.
            `;
            document.getElementById('error-banner').style.display = 'block';
            document.getElementById('ria').textContent = 'Non dispoñible';
            document.getElementById('ria').style.color = 'red'
            document.getElementById('poligono').textContent = 'Non dispoñible'
            document.getElementById('poligono').style.color = 'red'
            document.getElementById('asterisk_required').style.display = 'inline';
        }

        function buscarCercano(latitud, longitud, ria) {
            fetch('https://raw.githubusercontent.com/chesucr/jotform_widget/refs/heads/gh-pages/location/loc_polygon.csv')
                .then(response => response.text())
                .then(data => procesarCSV(data, latitud, longitud, ria));
        }

        function procesarCSV(data, latitud, longitud, ria) {
            const filas = data.split('\n').slice(1);
            let cercano = null;
            let distanciaMinima = Infinity;

            filas.forEach(fila => {
                const columnas = fila.split(',');
                const nombreRia = columnas[0].trim(); // Suponiendo que la ría está en la primera columna
                const lat = parseFloat(columnas[3]);
                const lon = parseFloat(columnas[2]);

                // Verificamos que la fila corresponde a la ría especificada y que las coordenadas son válidas
                if (nombreRia === ria && !isNaN(lat) && !isNaN(lon)) {
                    const distancia = calcularDistancia(latitud, longitud, lat, lon);
                    if (distancia < distanciaMinima) {
                        distanciaMinima = distancia;
                        cercano = {
                            ria: nombreRia,
                            poligono: columnas[1], // Suponiendo que el polígono está en la segunda columna
                            lat: lat,
                            lon: lon
                        };
                    }
                }
            });

            if (cercano) {
                document.getElementById('ria').innerHTML = cercano.ria;
                document.getElementById('poligono').innerHTML = cercano.poligono;
                document.getElementById('latitud').innerHTML = cercano.lat;
                document.getElementById('longitud').innerHTML = cercano.lon;
            } else {
                document.getElementById('ria').innerHTML = "Non dispoñible";
                document.getElementById('poligono').innerHTML = "Non dispoñible";
            }
        }


        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radio de la Tierra en kilómetros
            const dLat = (lat2 - lat1) * (Math.PI / 180);
            const dLon = (lon2 - lon1) * (Math.PI / 180);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                        Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                        Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distancia en kilómetros
        }

        JFCustomWidget.subscribe("ready", function() {
            get_location();
        });
    </script>
</body>
</html>
