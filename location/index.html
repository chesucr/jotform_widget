<!DOCTYPE html>
<html>
<head>
    <title>Widget de Geolocalización</title>
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
</head>
<body>
    <div id="main">
        <h3>Tu Ubicación GPS</h3>
        <div id="error-banner" class="hidden">No se puede acceder a los datos de localización porque el usuario denegó el permiso en el navegador.</div>
        <table id="location-table">
            <thead>
                <tr>
                    <th>Latitud</th>
                    <th>Longitud</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="latitud">Cargando...</td>
                    <td id="longitud">Cargando...</td>
                </tr>
            </tbody>
        </table>
        <div id="map">
            El mapa aparecerá aquí
        </div>
    </div>

    <script type="text/javascript">
        JFCustomWidget.subscribe("ready", function() {
            function obtenerUbicacion() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(mostrarUbicacion, mostrarError);
                } else {
                    alert("La geolocalización no es soportada por este navegador.");
                }
            }

            function mostrarUbicacion(posicion) {
                var latitud = posicion.coords.latitude;
                var longitud = posicion.coords.longitude;
                document.getElementById('latitud').innerHTML = latitud;
                document.getElementById('longitud').innerHTML = longitud;
                var ubicacionString = `{'lon': ${longitud}, 'lat': ${latitud}}`;
                var map = document.getElementById('map');
                var urlMapa = `https://maps.google.com/maps?q=${latitud},${longitud}&z=15&output=embed&maptype=satellite`;
                map.innerHTML = `<iframe width="100%" height="100%" src="${urlMapa}" frameborder="0" allowfullscreen></iframe>`;
                var msg = {
                    value: ubicacionString
                };
                JFCustomWidget.sendData(msg);
            }

            function mostrarError(error) {
                if (error.code === error.PERMISSION_DENIED) {
                    document.getElementById('error-banner').style.display = 'block';
                    document.getElementById('location-table').style.display = 'none';
                    document.getElementById('map').style.display = 'none';
                }
            }

            obtenerUbicacion();
        });
    </script>
</body>
</html>
