<!DOCTYPE html>
<html>
<head>
    <title>Widget de Geolocalización</title>
    <link rel="stylesheet" type="text/css" href="styles.css"> <!-- Enlaza el archivo CSS -->
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
</head>
<body>
    <div id="main">
        <h3>Tu Ubicación GPS</h3>

        <!-- Tabla para mostrar latitud y longitud -->
        <table>
            <thead>
                <tr>
                    <th>Latitud</th>
                    <th>Longitud</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td id="latitud">Cargando...</td>
                    <td id="longitud">Cargando...</td>
                </tr>
            </tbody>
        </table>

        <!-- Mapa de Google Maps para mostrar la ubicación -->
        <div id="map">
            El mapa aparecerá aquí
        </div>
    </div>

    <script type="text/javascript">
        // Siempre suscribirse al evento ready y desarrollar la lógica del widget dentro del callback
        JFCustomWidget.subscribe("ready", function() {

            // Función para obtener la ubicación del usuario
            function obtenerUbicacion() {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(mostrarUbicacion, mostrarError);
                } else {
                    alert("La geolocalización no es soportada por este navegador.");
                }
            }

            // Mostrar la ubicación en la tabla y en el mapa
            function mostrarUbicacion(posicion) {
                var latitud = posicion.coords.latitude;
                var longitud = posicion.coords.longitude;

                // Asignar valores a la tabla
                document.getElementById('latitud').innerHTML = latitud;
                document.getElementById('longitud').innerHTML = longitud;

                // Crear el string en formato {'lon': longitud, 'lat': latitud}
                var ubicacionString = `{'lon': ${longitud}, 'lat': ${latitud}}`;

                // Mostrar la ubicación en un mapa de Google Maps
                var map = document.getElementById('map');
                var urlMapa = `https://maps.google.com/maps?q=${latitud},${longitud}&z=15&output=embed`;
                map.innerHTML = `<iframe width="100%" height="100%" src="${urlMapa}" frameborder="0" allowfullscreen></iframe>`;

                // Enviar los datos de la ubicación a JotForm usando sendData
                var msg = {
                    value: ubicacionString
                };
                JFCustomWidget.sendData(msg);
            }

            // Manejar los posibles errores de geolocalización
            function mostrarError(error) {
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        alert("El usuario denegó el permiso para la geolocalización.");
                        break;
                    case error.POSITION_UNAVAILABLE:
                        alert("La información de la ubicación no está disponible.");
                        break;
                    case error.TIMEOUT:
                        alert("La solicitud para obtener la ubicación ha caducado.");
                        break;
                    case error.UNKNOWN_ERROR:
                        alert("Se ha producido un error desconocido.");
                        break;
                }
            }

            // Llama a la función para obtener la ubicación cuando el widget esté listo
            obtenerUbicacion();
        });
    </script>
</body>
</html>
